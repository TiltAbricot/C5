<!-- Complete Circle of Fifths App with Binary-Based Shape Names (Version 0.2.2) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Circle of Fifths</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 1em; }
    svg { width: 90vw; height: 90vw; max-width: 500px; max-height: 500px; }
    circle.note { fill: white; stroke: black; cursor: pointer; }
    circle.note.selected { fill: lightblue; }
    text { font-size: 14px; text-anchor: middle; dominant-baseline: middle; pointer-events: none; }
    polygon { stroke-width: 2; }
    .controls { margin-top: 20px; max-width: 500px; width: 100%; display: flex; flex-direction: column; gap: 0.5em; }
    .shape-list { display: flex; flex-direction: column; gap: 0.5em; }
    .shape-item { display: flex; justify-content: space-between; align-items: center; background: #eee; padding: 0.5em; border-radius: 5px; }
    #app-version { font-size: 0.9em; color: gray; margin-top: 1em; }
  </style>
</head>
<body>
  <svg id="circle"></svg>
  <div class="controls">
    <button id="save-shape">Save Shape</button>
    <button id="clear-button">Clear Selection</button>
    <button id="clear-all">Clear All Shapes</button>
    <input type="number" id="shape-id-input" placeholder="Enter shape decimal ID">
    <button id="add-shape-by-id">Add Shape by ID</button>
    <div id="chord-name"></div>
    <div class="shape-list" id="shape-list"></div>
    <div id="app-version">Version: 0.2.2</div>
  </div>
  <script>
    const svg = document.getElementById("circle");
    const shapeList = document.getElementById("shape-list");
    const chordNameDisplay = document.getElementById("chord-name");

    const chromatic = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const circleFifths = Array.from({ length: 12 }, (_, i) => chromatic[(0 + i * 7) % 12]);

    const selectedNotes = new Set();
    const savedShapes = [];
    const shapeColors = [
      "rgba(100,150,255,0.4)", "rgba(255,100,100,0.4)", "rgba(100,255,150,0.4)",
      "rgba(255,255,100,0.4)", "rgba(200,100,255,0.4)", "rgba(255,150,150,0.4)", "rgba(150,255,255,0.4)"
    ];

    const center = 200;
    const radius = 170;

    function getCoords(note) {
      const i = circleFifths.indexOf(note);
      const angle = (Math.PI * 2 * i / 12) - Math.PI / 2;
      return [center + radius * Math.cos(angle), center + radius * Math.sin(angle)];
    }

    function drawShapes() {
      savedShapes.forEach(({ notes, color }) => {
        const coords = circleFifths.filter(n => notes.has(n)).map(n => getCoords(n));
        if (coords.length >= 2) {
          const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
          polygon.setAttribute("points", coords.map(([x, y]) => `${x},${y}`).join(" "));
          polygon.setAttribute("fill", color);
          polygon.setAttribute("stroke", color.replace(/0\.4\)/, "1)"));
          svg.appendChild(polygon);
        }
      });
    }

    function drawCurrentShape() {
      const coords = circleFifths.filter(n => selectedNotes.has(n)).map(n => getCoords(n));
      if (coords.length >= 2) {
        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        polygon.setAttribute("points", coords.map(([x, y]) => `${x},${y}`).join(" "));
        polygon.setAttribute("fill", "rgba(150,150,150,0.4)");
        polygon.setAttribute("stroke", "gray");
        svg.appendChild(polygon);
      }
    }

    function drawNotes() {
      circleFifths.forEach(note => {
        const [x, y] = getCoords(note);

        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", x);
        circle.setAttribute("cy", y);
        circle.setAttribute("r", 20);
        circle.classList.add("note");
        if (selectedNotes.has(note)) circle.classList.add("selected");
        circle.addEventListener("click", () => {
          if (selectedNotes.has(note)) selectedNotes.delete(note);
          else selectedNotes.add(note);
          update();
        });
        svg.appendChild(circle);

        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", x);
        label.setAttribute("y", y);
        label.textContent = note;
        svg.appendChild(label);
      });
    }

    function getShapeBinaryDecimal(notes) {
      const binary = circleFifths.map(n => notes.has(n) ? "1" : "0");
      let min = parseInt(binary.join(""), 2);
      for (let i = 1; i < binary.length; i++) {
        const rotated = binary.slice(i).concat(binary.slice(0, i));
        const val = parseInt(rotated.join(""), 2);
        if (val < min) min = val;
      }
      return min;
    }

    function updateShapeList() {
      shapeList.innerHTML = "";
      savedShapes.forEach(({ notes }, index) => {
        const shapeID = getShapeBinaryDecimal(notes);
        const div = document.createElement("div");
        div.className = "shape-item";

        const span = document.createElement("span");
        span.textContent = `Shape ${shapeID}`;
        span.style.cursor = "pointer";
        span.onclick = () => {
          selectedNotes.clear();
          notes.forEach(n => selectedNotes.add(n));
          update();
        };

        const rotateLeftBtn = document.createElement("button");
        rotateLeftBtn.textContent = "⟲";
        rotateLeftBtn.title = "Rotate Left";
        rotateLeftBtn.onclick = () => {
          const rotated = new Set();
          circleFifths.forEach((note, i) => {
            const prev = circleFifths[(i + 1) % 12];
            if (notes.has(prev)) rotated.add(note);
          });
          savedShapes[index].notes = rotated;
          updateShapeList();
          update();
        };

        const rotateRightBtn = document.createElement("button");
        rotateRightBtn.textContent = "⟳";
        rotateRightBtn.title = "Rotate Right";
        rotateRightBtn.onclick = () => {
          const rotated = new Set();
          circleFifths.forEach((note, i) => {
            const next = circleFifths[(i + 11) % 12];
            if (notes.has(next)) rotated.add(note);
          });
          savedShapes[index].notes = rotated;
          updateShapeList();
          update();
        };

        
        mergeBtn.onclick = () => {
          notes.forEach(n => selectedNotes.add(n));
          update();
        };

        const delBtn = document.createElement("button");
        delBtn.textContent = "✖";
        delBtn.onclick = () => {
          savedShapes.splice(index, 1);
          updateShapeList();
          update();
        };

        
        div.appendChild(rotateLeftBtn);
        div.appendChild(rotateRightBtn);
        
        div.appendChild(delBtn);
        shapeList.appendChild(div);
      });
    }

    function update() {
      svg.innerHTML = "";
      drawShapes();
      drawCurrentShape();
      drawNotes();
    }

    document.getElementById("save-shape").addEventListener("click", () => {
      if (selectedNotes.size > 1) {
        const color = shapeColors[savedShapes.length % shapeColors.length];
        savedShapes.push({ notes: new Set(selectedNotes), color });
        selectedNotes.clear();
        updateShapeList();
        update();
      }
    });

    document.getElementById("clear-button").addEventListener("click", () => {
      selectedNotes.clear();
      update();
    });

    document.getElementById("clear-all").addEventListener("click", () => {
      savedShapes.length = 0;
      updateShapeList();
      update();
    });

    document.getElementById("add-shape-by-id").addEventListener("click", () => {
      const input = document.getElementById("shape-id-input");
      const decimal = parseInt(input.value);
      if (isNaN(decimal)) return;
      const binary = decimal.toString(2).padStart(12, "0");
      const notes = new Set();
      [...binary].forEach((bit, i) => {
        if (bit === "1") notes.add(circleFifths[i]);
      });
      const color = shapeColors[savedShapes.length % shapeColors.length];
      savedShapes.push({ notes, color });
      updateShapeList();
      update();
    });

    update();
  </script>
</body>
</html>
